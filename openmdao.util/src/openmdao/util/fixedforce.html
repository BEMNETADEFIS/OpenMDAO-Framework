<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en">
<head>
  <meta charset="utf-8">
    <style>

    .link {
      stroke: #000;
      stroke-width: 1.5px;
      marker-mid: url(#mArrow);
      fill: none;
    }

    .node {
      cursor: move;
      fill: #ccc;
      stroke: #000;
      stroke-width: 1.5px;
    }

    .node.fixed {
      fill: #f00;
    }

    #arrowPath {
      fill: none;
      stroke: black;
    }

    </style>
  <title>Fixed force layout</title>
  <script type="text/javascript" src="d3.js"></script>
  <script type="text/javascript" src="__graph.js"></script>
</head>
<body>
<script type="text/javascript" charset="utf-8">

var graph = __mygraph__json;

var width = 960,
    height = 500;

var force = d3.layout.force()
    .size([width, height])
    .charge(-400)
    .linkDistance(function(lnk, idx) {
            // source and target are node objects at this point
            var sparts = lnk.source.id.split(".");
            var tparts = lnk.target.id.split(".");
            // make var comp and var to subvar connections shorter
            if (sparts[0] === tparts[0]) {
                return 30;
            }
            else {
                return 60;
            }
    })
    .linkStrength(function(lnk, idx) {
                var sparts = lnk.source.id.split(".");
                var tparts = lnk.target.id.split(".");
                // make var comp and var to subvar connections shorter
                if (sparts[0] === tparts[0]) {
                    return 1.0;
                }
                else {
                    return 0.2;
                }
    })
    .on("tick", tick);

var drag = force.drag()
    .on("dragstart", dragstart);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)


svg.append("marker")
   .attr("id", "mArrow")
    .attr("markerWidth", 6)
    .attr("markerHeight", 10)
    .attr("refX", 0)
    .attr("refY", 4)
    .attr("orient", "auto")
   .append("path")
   .attr("id", "arrowPath")
   .attr("d", "M 0 0 4 4 0 8");

var link = svg.selectAll(".link"),
    node = svg.selectAll(".node");

  force.nodes(graph.nodes)
       .links(graph.links)
       .start();

  link = link.data(graph.links)
    .enter()
    //.append("line")
    //.attr("class", "link");
    .append("path")
    .attr("class", "link");

  node = node.data(graph.nodes)
    .enter()
    .append("g")
    .attr("class", "nodegroup")
    .call(drag);

  node.append("circle")
      .attr("class", "node")
      .attr("r", 12)
      .call(drag);

  node.append("text")
      .attr("dx", 16)
      .attr("dy", ".35em")
      .text(function(d) { return d.id; });

function tick() {
  link//.select(".link")
      //.attr("x1", function(d) { return d.source.x; })
      //.attr("y1", function(d) { return d.source.y; })
      //.attr("x2", function(d) { return d.target.x; })
      //.attr("y2", function(d) { return d.target.y; });
      .attr("d", function(d) {
        var pth = [d.source.x, d.source.y,
                   d.source.x+(d.target.x-d.source.x)/2,
                   d.source.y+(d.target.y-d.source.y)/2,
                   d.target.x, d.target.y
                  ];
        return "M "+pth.join(" ");
      });

  node.attr("transform", function(d) { 
        return "translate(" + d.x + "," + d.y + ")"; });
  //node.attr("cx", function(d) { return d.x; })
  //    .attr("cy", function(d) { return d.y; });
}

function dragstart(d) {
  d.fixed = true;
  d3.select(this).classed("fixed", true);
}

function make_arrow(x1,y1,x2,y2) {
  var mid_x = (x2-x1)/2.;
  var mid_y = (y2-y1)/2.;

}

</script>
</body>
</html>

