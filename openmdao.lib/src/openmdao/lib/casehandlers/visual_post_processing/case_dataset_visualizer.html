<html>
    <head>
        <link rel='stylesheet' type='text/css' href='http://w2ui.com/src/w2ui-1.4.1.min.css' />
        <script src='http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script type='text/javascript' src='http://w2ui.com/src/w2ui-1.4.1.min.js'></script>
    </head>
    <body>
        <div id='main' style='width: 100%; height: 100%;'></div>
        <div id='graph' style='display:none;'>
            {{ svg_graph }}
        </div>
        <script id='case-data' type='application/json'>
            {{ case_data }}
        </script>
        <script id='visualizer' type='text/javascript'>
            //global variable for reference case data
            var case_data = JSON.parse(document.getElementById('case-data').innerHTML);

            // recursive function to build up the JavaScript structure that w2ui needs for
            //   display of a sidebar
            function get_nodes( root ) {
                var nodes = [] ;
                var children = root.children ;
                var child ;

                // Add a label for the driver name at this hierarchy level
                if (children.length > 0) {
                    nodes[nodes.length] = {id: children[0].driver_name + '_' + children[0].case_number.toString(),
                                           text: children[0].driver_name.toString(),
                                           img: 'icon-page' };
                }
                else {
                    // there are no cases to pull driver info from, so just add a default driver node
                    nodes[nodes.length] = {id: 'driver', text: 'driver', img: 'icon-page' };
                }
                for (var i=0; i < children.length; i++) {
                    child = children[i] ;
                    if ( child.children.length ) { // if node has subnodes, recurse
                        child_nodes = get_nodes( child ) ;
                        // nodes[nodes.length] = {id: child.case_number.toString(), text: child.case_number.toString() + ' (' + child.driver_name + ')', nodes: child_nodes } ;
                        nodes[nodes.length] = {id: child.case_number.toString(), text: child.case_number.toString() , nodes: child_nodes } ;
                    }
                    else {
                        // nodes[nodes.length] = {id: child.case_number.toString(), text: child.case_number.toString() + ' (' + child.driver_name + ')' } ;
                        nodes[nodes.length] = {id: child.case_number.toString(), text: child.case_number.toString() } ;
                    }
                }
                return nodes ;
            } ; // end get_nodes function

            // widget configuration
            var config = {
                layout: {
                    name: 'layout',
                    padding: 0,
                    panels: [
                        { type: 'left', size: 200, resizable: true, minSize: 120 },
                        { type: 'main',  minSize: 550, overflow: 'hidden' }
                    ]
                },
            };

            jQuery( document ).ready(function() {
                var cases = [];
                var it_case_key = "iteration_case_" ;
                var simulation_info_key = "simulation_info" ;
                var driver_info_key = "driver_info" ;
                var case_objects = new Object();
                var simulation_info_id = "" ;
                var driver_id_name_map = new Object() ;
                var num_orphan_cases = 0 ;

                // get all the cases in an associative array with the id as the key
                jQuery.each( case_data, function( key , val ) {

                   // need to add simulation info object for top of tree of cases
                   if (key.lastIndexOf(simulation_info_key, 0) === 0) {
                        val[ 'children'] = [] ;
                        case_objects[ val.uuid ] = val ;
                        simulation_info_id = val.uuid ; // need to remember this since it is special since it is not really a case
                    }

                    // Make a structure to hold all of the driver info
                    if (key.lastIndexOf(driver_info_key, 0) === 0) {
                        driver_id_name_map[ val._id ] = val.name;
                    }

                    // Make a structure to hold all of the case info
                    if (key.lastIndexOf(it_case_key, 0) === 0) {
                        case_number = key.substring(it_case_key.length);
                        val[ 'children'] = [] ;
                        val[ 'case_number'] = case_number ;
                        val[ 'driver_name'] = driver_id_name_map[val._driver_id] ;
                        case_objects[ val._id ] = val ;
                    }
                }); // end each

                // Loop over the case_objects and connect parents to children and vice versa
                Object.keys(case_objects).forEach(function(key) {
                    var case_object, parent_id, parent_case_object, parent_case_object_children ;
                    if ( key != simulation_info_id )
                    {
                        case_object = case_objects[key];
                        parent_id = case_object._parent_id ;
                        parent_case_object = case_objects[parent_id] ;
                        // have to handle the case where a case does not have a parent
                        if ( parent_case_object ) {
                            parent_case_object_children = parent_case_object.children ;
                            parent_case_object_children[ parent_case_object_children.length ] = case_object ;
                        }
                        else {
                            num_orphan_cases++ ;
                        }
                    }
                }); // end keys

                if ( num_orphan_cases > 0 ) {
                    alert("WARNING: There were " + num_orphan_cases.toString() + " cases with no parent cases");
                }
                // Starting from the top "case_object", which is really the sim info data,
                // Walk down the children leaves, creating the value for nodes in the w2ui call below
                simulation_info_object = case_objects[simulation_info_id] ;
                node_tree = get_nodes(simulation_info_object);

                // the SVG graph is in the hidden div 'graph'
                var graph_div = document.getElementById('graph')

                // use w2ui to do the layout of the divs
                jQuery('#main').w2layout(config.layout);
                w2ui.layout.content('main', '<div id="svgContent" style="background-color:white">'+graph_div.innerHTML+'</div>' );
                w2ui.layout.content('left', jQuery().w2sidebar(
                    {
                        name: 'cases',
                        nodes: node_tree ,
                        onClick: function(event) {
                            if ( event.node.img != "icon-page" ) { // Clicking on driver name label should not do anything for now
                                alert( 'case ' + event.target + ' clicked'); // just a dummy thing to do for now
                                //w2ui.layout.content('main', '<div style="padding: 10px">case ' + event.target + ' clicked</div>' );
                            }
                        }  ,
                    }
                )); // end layout content left

                var svg = d3.select("#svgContent svg")
                              .attr("height", "100%")
                              .attr("width", "100%")
                              .attr('preserveAspectRatio', 'xMinYMin slice') ;

                var vis = d3.select("#svgContent svg g")
                    .call(d3.behavior.zoom().on("zoom", rescale))
                    .on("dblclick.zoom", null);

                function rescale() {
                  trans=d3.event.translate;
                  scale=d3.event.scale;
                  vis.attr("transform",
                      "translate(" + trans + ")"
                      + " scale(" + scale + ")");
                }

                // vis.append('svg:rect')
                //     .attr('width', "100%")
                //     .attr('height', "100%")
                //     .attr('fill', 'white');

            }); // end ready
        </script>
    </body>
</html>